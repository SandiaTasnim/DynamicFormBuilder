@using X.PagedList
@using X.PagedList.Mvc.Core
@model IPagedList<DynamicFormBuilder.ViewModels.CustomerViewModel>



@*     
//    int pageNumber = Model.PageNumber; // Current page
  //  int pageSize = Model.PageSize;     // Items per page
   // int count = ((pageNumber - 1) * pageSize) + 1; // Starting SL for current page *@
@{
    // ensure these are set earlier in the file as shown before
    int pageSize = ViewBag.PageSize != null ? (int)ViewBag.PageSize : (Model?.PageSize ?? 10);
    int pageNumber = Model?.PageNumber ?? (ViewBag.CurrentPage != null ? (int)ViewBag.CurrentPage : 1);
    string currentName = ViewBag.SearchName ?? "";
    string currentPhone = ViewBag.SearchPhone ?? "";
    int count = ((pageNumber - 1) * pageSize) + 1;
}




    

<h2>Customers List</h2>
<button class="btn btn-primary mb-3" 
        onclick="window.location='@Url.Action("Create", "Customer")'">
    Add New Customer
</button>

<!-- Search Form -->
<form asp-action="Index" method="get" class="row g-3 mb-3">

    <!-- Always preserve page -->
    <input type="hidden" name="page" value="@ViewBag.CurrentPage" />

    <!-- Search by Name -->
    <div class="col-md-3">
        <input type="text" name="name" class="form-control" placeholder="Search by Name" value="@ViewBag.SearchName" />
    </div>

    <!-- Search by Phone -->
    <div class="col-md-3">
        <input type="text" name="phone" class="form-control" placeholder="Search by Phone" value="@ViewBag.SearchPhone" />
    </div>

  

  

    <!-- Buttons -->
    <div class="col-md-3">
        <button type="submit" class="btn btn-primary">Search</button>
        <a asp-action="Index" class="btn btn-secondary">Reset</a>

        <a asp-action="Excel_Download"
           asp-route-name="@ViewBag.SearchName"
           asp-route-phone="@ViewBag.SearchPhone"
           asp-route-division="@ViewBag.SearchDivisionId"
           class="btn btn-success ">
            Download Excel
        </a>
    </div>

</form>


<!-- Customers Table -->
<table class="table table-bordered table-striped">
    <thead>
        <tr>
            <th>SL</th>
            <th>Full Name</th>
            <th>Division</th>
            <th>District</th>
            <th>Phone</th>
            <th>Email</th>
            <th>NID</th>
            <th>DOB</th>
            <th>Profession</th>
            <th>Balance</th>
            <th>Actions</th>
        </tr>
    </thead>
    <tbody>
        @foreach (var customer in Model)
        {
            <tr>
                <td>@(count++)</td>
                <td>@customer.FullName</td>
                <td>@customer.DivisionName</td>
                <td>@customer.DistrictName</td>
                <td>@customer.Phone</td>
                <td>@customer.Email</td>
                <td>@customer.NID</td>
                <td>@customer.DOB?.ToString("yyyy-MM-dd")</td>
                <td>@customer.Profession</td>
                <td>@customer.Balance.ToString("C")</td>
                <td>
                    <a asp-action="Details" asp-route-id="@customer.CustomerID" class="btn btn-sm btn-info">Details</a>
                    <a asp-action="Edit" asp-route-id="@customer.CustomerID" class="btn btn-sm btn-warning">Edit</a>
                    <a asp-action="Delete" asp-route-id="@customer.CustomerID" class="btn btn-sm btn-danger">Delete</a>
                     
                </td>
            </tr>
        }
    </tbody>
</table>

<script>
function changePageSize(size) {
    const url = new URL(window.location.href);
    url.searchParams.set('pageSize', size);
    url.searchParams.set('page', 1); // reset to first page
    window.location.href = url;
}
</script>




<div class="d-flex justify-content-between align-items-center mt-3">
    <!-- LEFT: pager -->
    <div>
        @Html.PagedListPager(
            Model,
            page => Url.Action("Index", new {
                page,
                pageSize = pageSize,         // IMPORTANT: keep pageSize in pager links
                name = currentName,
                phone = currentPhone
            }),
            new PagedListRenderOptions
            {
                DisplayEllipsesWhenNotShowingAllPageNumbers = true,
                MaximumPageNumbersToDisplay = 10,
                LiElementClasses = new[] { "page-item" },
                PageClasses = new[] { "page-link" },
                UlElementClasses = new[] { "pagination" },
                DisplayLinkToNextPage = PagedListDisplayMode.Always,
                DisplayLinkToPreviousPage = PagedListDisplayMode.Always,
                DisplayLinkToFirstPage = PagedListDisplayMode.Always,
                DisplayLinkToLastPage = PagedListDisplayMode.Always
            }
        )
    </div>

    <!-- RIGHT: page size selector (inside a GET form so it submits filters) -->
    <div>
        <form asp-action="Index" method="get" class="d-flex align-items-center">
            <!-- preserve current filters -->
            <input type="hidden" name="name" value="@currentName" />
            <input type="hidden" name="phone" value="@currentPhone" />
            <!-- reset to first page when size changes -->
            <input type="hidden" name="page" value="1" />

            <label class="me-2 mb-0">Page size</label>
            @Html.DropDownList(
                "pageSize",
                new List<SelectListItem> {
                    new SelectListItem { Text="5", Value="5", Selected = (pageSize==5) },
                    new SelectListItem { Text="10", Value="10", Selected = (pageSize==10) },
                    new SelectListItem { Text="20", Value="20", Selected = (pageSize==20) },
                    new SelectListItem { Text="50", Value="50", Selected = (pageSize==50) }
                },
                new { @class = "form-select form-select-sm", onchange = "this.form.submit()", style = "width:85px;" }
            )
        </form>
    </div>
</div>



